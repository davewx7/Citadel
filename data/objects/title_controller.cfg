{
	id: "title_controller",
	is_human: true,
	hitpoints: 20,
	editor_info: { category: "player" },
    hidden_in_level: true,
    use_absolute_screen_coordinates: true,

    vars: {
		client: null,
		session_id: -1,
		bot_types: [],
		
		state: null,
		
		font: 'RobotoCondensed-Regular',
		font_color: 'antique_white',
		
		bot1: null,
		bot2: null,
    },
    tmp: {
        username: "@eval USERNAME",
		bvb_menu_shown: false,
		bvb_match: false,
		bvb_button_enabled: false,
		bot1_session_id: -1,
		bot2_session_id: -1,
		obs_sesssion_id: -1,
		bvb_game_id: -1,
		
		// Map of <deck_name>:{name:<deck_name>, cards:[(list of cards], schools:[(list of schools)]}
		user_decks: {},
		// List of <deck_name> that correspond to the selections in the deck_grid widget.
		deck_list: [],
		selected_deck: '',
    },

    consts: {
		button_width: 220,
		button_height: 35,
    },
	
	is_strict: true,
	
    properties: {
		level_width: "level.dimensions[2]",
		level_height: "level.dimensions[3]",
		
		get_server_info: "[tbs_send(cl, {type: 'get_server_info'}), set(vars.client, cl)] where cl = tbs_client('localhost', 23456, -1)",
		
		// We need to schedule removal of the bot vs. bot menu due to a nasty internal bug with processing and iterator invalidation.
		remove_bot_vs_bot_menu: "[
			set(tmp.bvb_menu_shown, false),
			set(me.widgets.bvb_dlg, null)
		]",
		
		do_fast_play_send: "def(sid, cl) [
			set(vars.session_id, sid),
			set(tmp.bvb_match, false),
			tbs_send(cl, {type: 'create_game', game_type: 'citadel', users: [{user: USERNAME or 'a', session_id: sid}, {user: 'b', bot_type: 'aggro', bot: true, session_id: 1d30000}]})
		]",
		
		do_fast_play: "if(vars.client, 
			do_fast_play_send(1d30000, vars.client), 
			[set(vars.client, cl), do_fast_play_send(1d30000, cl)] where cl = tbs_client('localhost', 23456)
		)",
		
		error_text: "def(txt) set(me.widgets.error_text.text, txt)",
		
		do_bot_vs_bot: "def(wwidth, hheight)
			set(me.widgets.child, {				
				type: 'dialog',
				id: 'bvb_dlg',
				background_alpha: 255,
				background_frame: 'empty_window',
				zorder: 1100,
				rect:[wwidth/4, hheight/4, wwidth/2, hheight/2],
				cursor: [20, 20],
				children:[
					{
						type: 'grid',
						columns: 2,
						column_alignments: 'center',
						column_widths: wwidth/4 - 40,
						children: [
							{
								type: 'grid',
								columns: 1,
								column_widths: wwidth/4 - 40,
								row_height: 30,
								allow_selection: true,
								default_select: 0,
								draw_selection_highlighted: true,
								max_height: hheight/2-100,
								allow_draw_highlight: true,
								column_alignments: 'centre',
								children: map(vars.bot_types, {type: 'label', size: 16, text: value, font: vars.font, color: vars.font_color}),
								on_select: 'if(selection >= 0, [set(vars.bot1, vars.bot_types[selection]), debug(q(bot1 = ), vars.bot_types[selection])])',
							},
							{
								type: 'grid',
								columns: 1,
								column_widths: wwidth/4 - 40,
								row_height: 30,
								allow_selection: true,
								default_select: 0,
								draw_selection_highlighted: true,
								max_height: hheight/2-100,
								allow_draw_highlight: true,
								column_alignments: 'centre',
								children: map(vars.bot_types, {type: 'label', size: 16, text: value, font: vars.font, color: vars.font_color}),
								on_select: 'if(selection >= 0, [set(vars.bot2, vars.bot_types[selection]), debug(q(bot2 = ), vars.bot_types[selection])])',
							},							
						],
					},
					{
						type: 'grid',
						columns: 2,
						column_alignments: 'center',
						column_widths: wwidth/4 - 40,
						children: [
							{
								type: 'button', 
								label:{type: 'label', size: 16, text: 'Cancel', font: vars.font, color: vars.font_color}, 
								wh:[150, consts.button_height], 
								on_click: 'schedule(1, remove_bot_vs_bot_menu)' 
							},
							{
								type: 'button', 
								label:{type: 'label', size: 16, text: 'Go!', font: vars.font, color: vars.font_color}, 
								wh:[150, consts.button_height], 
								on_click: '[schedule(1, remove_bot_vs_bot_menu), do_play_bots]' 
							},
						],
					},
				],
			})
		",
		
		do_observe: "def(bvb_game_id, obs_session_id) [
			tbs_send(vars.client, {type: 'observe_game', user: 'Observer', session_id: obs_session_id, game_id: bvb_game_id}),
			set(tmp.obs_sesssion_id, obs_session_id)
		]",
		
		do_play_bots_send: "def(cl) [
			tbs_send(cl, {
				type: 'create_game', 
				game_type: 'citadel', 
				users: [
					{ user: 'FightBot-A', bot: true, bot_type: vars.bot1, session_id: b1id }, 
					{ user: 'FightBot-B', bot: true, bot_type: vars.bot2, session_id: b2id }
				]
			}),
			set(tmp.bvb_match, true),
			set(tmp.bot1_session_id, b1id),
			set(tmp.bot2_session_id, b2id),
		] where b1id = 1d30000, b2id = 1d30000",
		
		do_play_bots: "if(vars.bot1 and vars.bot2, 
			if(vars.client, 
				do_play_bots_send(vars.client), 
				[set(vars.client, cl), do_play_bots_send(cl)] where cl = tbs_client('localhost', 23456)),
			error_text('Need to choose what bots to use')
		)",
		
		draw_menu: "def(wwidth, hheight, user_decks) [set(me.widgets, {
			type: 'dialog',
			id: 'background_dlg',
			background_alpha: 255,
			rect: [0, 0, wwidth, hheight],
			children: [
				{ type: 'image', image: 'title2.png', image_width: calc_w, image_height:350, x: (wwidth-calc_w)/2, y: 20 },
				{
					type: 'dialog',
					id: 'dlg',
					background_frame: 'empty_window',
					background_alpha: 20,
					rect: [wwidth/16, hheight/2+40, 14*wwidth/16, hheight/2-50],
					cursor: [35, 20],
					children: [
						{
							type: 'grid',
							columns: 2,
							column_widths: 6*wwidth/16,
							column_alignments: 'center',
							children: [
								{
									type: 'grid',
									columns: 1,
									column_widths: 6*wwidth/16,
									column_alignments: 'center',
									children: [
										{type: 'button', id:'campaign_button', label:{type: 'label', size: 16, text: 'Play Campaign (single player)', font: vars.font, color: vars.font_color}, wh:[consts.button_width, consts.button_height], on_click: def() fire_event('do_campaign_game') },
										{type: 'button', id:'puzzle_button', label:{type: 'label', size: 16, text: 'Play Puzzle (single player)', font: vars.font, color: vars.font_color}, enabled: false, wh:[consts.button_width, consts.button_height], on_click: 'debug(q(clicked play puzzle))' },
										{type: 'button', id:'mplobby_button', label:{type: 'label', size: 16, text: 'Play Multiplayer Game', font: vars.font, color: vars.font_color}, wh:[consts.button_width, consts.button_height], on_click: def() fire_event('do_mp_lobby') },
										{type: 'button', id:'fastplay_button', label:{type: 'label', size: 16, text: 'Fast Play (single player)', font: vars.font, color: vars.font_color}, wh:[consts.button_width, consts.button_height], on_click: 'do_fast_play' },
									],
								},
								{
									type: 'grid',
									columns: 1,
									column_widths: 6*wwidth/16,
									column_alignments: 'center',
									children: [
										{type: 'button', id:'leveleditor_button', label:{type: 'label', size: 16, text: 'Level Editor', font: vars.font, color: vars.font_color}, wh:[consts.button_width, consts.button_height], on_click: 'fire_event(q(do_leveleditor))' },
										{type: 'button', id:'deckbuilder_button', label:{type: 'label', size: 16, text: 'Deck Builder', font: vars.font, color: vars.font_color}, wh:[consts.button_width, consts.button_height], on_click: 'fire_event(q(do_deckbuilder))' },
										{type: 'button', id:'botvsbot_button', label:{type: 'label', size: 16, text: 'Bot vs. Bot', font: vars.font, color: vars.font_color}, enabled: tmp.bvb_button_enabled, wh:[consts.button_width, consts.button_height], on_click: '[do_bot_vs_bot(SCREEN_WIDTH, SCREEN_HEIGHT), set(tmp.bvb_menu_shown, true)]' },
										{type: 'label', text:''},
									],
								},
							],
						},
						{
							type: 'grid', 
							columns: 1,
							row_height: 20,
							column_widths: 12*wwidth/16,
							column_alignments: 'left',
							children: [
								{type: 'label', id: 'error_text', size:20, text: '', font: 'RobotoCondensed-Bold', color: 'red'},
							],
						},
						deck_grid_widget
					],
				},
			],
		}), set(deck_grid_widget.x, level_width/4)] where calc_w = if(wwidth > 750, 750, wwidth), deck_grid_widget = make_deck_grid(user_decks)",
		
		make_school_icon: "def(school) switch(school, 
			// Colorless -- mana only
			0, widget(me, {type: 'label', text:'Mana', font: vars.font, color: vars.font_color, size: 14}),
			// gold
			1, widget(me, {type:'image', image:'magic-icons.png', area:[3,3,18,18]}),
			// blood
			2, widget(me, {type:'image', image:'magic-icons.png', area:[20,3,35,18]}),
			// food
			3, widget(me, {type:'image', image:'magic-icons.png', area:[37,3,52,18]}),
			// scrolls
			4, widget(me, {type:'image', image:'magic-icons.png', area:[54,3,69,18]}),
			// faith
			5, widget(me, {type:'image', image:'magic-icons.png', area:[71,3,86,18]})) 
			asserting school >= 0 and school <= 5",
			
		make_deck_list: "def(user_decks) map(user_decks, widget(me, {
			type: 'grid', 
			columns: 2,
			column_alignments: ['left', 'right'],
			column_widths: level_width/4,
			children: [{
				type:'label', 
				font:vars.font, 
				size:16, 
				color:vars.font_color, 
				text:value.name
			}, {
				type: 'grid',
				columns: size(value.schools),				
				children: map(value.schools, school, make_school_icon(school)),
			}],
		}))",
		
		make_deck_grid: "def(user_decks) widget(me, {
			type: 'grid', 
			allow_selection: true,
			draw_selection_highlighted: true,
			id: 'deck_grid',
			columns: 1,
			column_widths: level_width/2,
			max_height: 100,
			default_select: if(size(user_decks), 0, -1),
			children: make_deck_list(user_decks),
			on_select: def(selection) if(selection >= 0 and tmp.user_decks, set(tmp.selected_deck, tmp.deck_list[selection])),
		})",
    },
      
    on_create: "[
		//construct all cards so we will error if there are any problems.
		map(['blood', 'colorless', 'food', 'scrolls', 'faith', 'gold'],
		  map(keys(get_document(fname)),
		    edit_and_continue(
			  construct('card', get_document(fname)[value]), fname)
		     ) where fname = 'data/cards-' + value + '.cfg') and null,

		draw_menu(SCREEN_WIDTH, SCREEN_HEIGHT, user_decks), 
		schedule(5, [get_server_info]),
		if(user_decks, [set(tmp.user_decks, user_decks), set(tmp.deck_list, map(user_decks, key)), set(tmp.selected_deck, map(user_decks, key)[0]), debug('SET USER DECKS: ' + map(user_decks, key)[0])]),
		fire_event('window_resize', {width: level.camera_position[2], height: level.camera_position[3]}),
	] where user_decks = get_document('user-decks.cfg',['null_on_failure','user_preferences_dir'])",
	
	on_window_resize: "[
		draw_menu(width, height, tmp.user_decks), 
		if(tmp.bvb_menu_shown, do_bot_vs_bot(width, height)),
		set(level.dimensions, [0,0,width,height]),
	]",
	
	on_process: "if(vars.client, tbs_process(vars.client))",
    
    on_connection_error: "error_text('CONNECTION ERROR: ' + error)",
    
	on_connection_success: "error_text(null)",
	
	on_message_received: "[debug(message.type, message), switch(message.type,
		'game_created', 
		if(tmp.bvb_match, 
			[do_observe(message.bvb_game_id, 1d3000), set(tmp.bvb_game_id, message.game_id)],
			[
			debug('SETTING DECK: ' + tmp.selected_deck),
			set(playable.vars.selected_deck, tmp.selected_deck),
			teleport('level1.cfg', '', 'fade', playable)
			]
			   where playable = object_playable('citadel_controller', 336, 372, 0, {game_server_address: 'localhost', game_server_port: 23456, session_id: vars.session_id, game_created: true, selected_deck: tmp.selected_deck})
		),
		'server_info',
		[if(message.bot_types, set(vars.bot_types, message.bot_types)), set(me.widgets.botvsbot_button.enable, true), set(tmp.bvb_button_enabled, true)],
		'observing_game',
		tbs_send(cl, {'start_game'}) where cl = tbs_client('localhost', 23456, tmp.bot1_session_id), 
		error_text('UNKNOWN MESSAGE RECIEVED: ' + message.type)
	)]",
	
	on_do_deckbuilder: "teleport('deck-builder.cfg', '', 'fade', playable) 
		where playable = object_playable('deck_builder_controller', 0, 0, 0)
	",
	
	on_do_leveleditor: "teleport('level-editor.cfg', '', 'fade', playable) 
		where playable = object_playable('level_editor_controller', 0, 0, 0)
	",
	
	on_do_mp_lobby: "teleport('lobby.cfg', '', 'fade', playable) 
		where playable = object_playable('lobby_controller', 0, 0, 0)
	",
	
	on_do_campaign_game: "teleport('campaign.cfg', '', 'fade', playable)
		where playable = object_playable('campaign_controller')
	",
	
	on_enter_level: "[
		debug('XXX', 'enter_level', user_decks),
		draw_menu(SCREEN_WIDTH, SCREEN_HEIGHT, user_decks), 
		if(user_decks, [set(tmp.user_decks, user_decks), set(tmp.deck_list, map(user_decks, key))]) 
	] where user_decks = get_document('user-decks.cfg',['null_on_failure','user_preferences_dir'])",
	
	animation: {
		id: "normal",
		image: "effects/particles.png",
		x: 86,
		y: 73,
		w: 28,
		h: 28,
		collide: [0,0,28,28],
		frames: 1,
		duration: 1000,
	},
}
